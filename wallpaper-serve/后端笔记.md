## 壁纸分享馆后端笔记

### 数据库设计

```
1 壁纸表 (wallpaper)
	ID、摘要、图片地址、类型（0普通、1专辑、2动态、3平板、4头像）、分类ID、状态（0待审核、1已通过、2未通过）、是否删除（0未删除、1已删除）、排序值、上传用户ID、查看次数、创建时间、更新时间
2 分类表 (category)
	ID、分类名称、封面、类型（0普通、1专辑、2动态、3平板、4头像）、排序值、状态（0禁用、1启用）、创建时间、更新时间
3 用户表 (user)
	ID、open_id（微信唯一标识）、用户名称、用户头像、用户性别（null未知、1男、0女）、格言、状态（0封禁、1正常、2管理员）、创建时间
4 反馈表 (feedback)
	ID、用户ID、分类ID、壁纸ID、类型（0点赞、1收藏、2下载）、状态（0取消、1有效）、创建时间、更新时间
5 问题反馈表 (problem)
	ID、类型（0壁纸需求、1问题反馈）、内容、用户ID、提交时间
```

### 创建数据表

```
1 壁纸表 (wallpaper)
   CREATE TABLE IF NOT EXISTS wallpaper (
       id CHAR(21) NOT NULL COMMENT 'ID',
       description VARCHAR(800) DEFAULT NULL COMMENT '摘要（限制200字）',
       url VARCHAR(255) DEFAULT NULL COMMENT '图片地址',
       video_url VARCHAR(255) DEFAULT NULL COMMENT '视频地址（动态壁纸，允许为空）',
       type TINYINT UNSIGNED DEFAULT 0 COMMENT '类型: 0-普通、1-专辑、2-动态、3-平板、4-头像',
       category_id CHAR(21) NOT NULL COMMENT '分类ID',
       labels VARCHAR(150) NOT NULL COMMENT '标签（逗号分隔）',
       status TINYINT UNSIGNED DEFAULT 0 COMMENT '状态: 0-待审核、1-已通过、2-未通过',
       is_delete TINYINT UNSIGNED NOT NULL DEFAULT 0 COMMENT '是否删除: 0-未删除、1-已删除',
       sort TINYINT UNSIGNED DEFAULT 100 COMMENT '排序值（0-255）',
       user_id CHAR(21) NOT NULL COMMENT '上传用户ID',
       count INT UNSIGNED NOT NULL DEFAULT 0 COMMENT '查看次数',
       createdate DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
       updatedate DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
       PRIMARY KEY (id),
       KEY idx_category (type, category_id, status, is_delete, createdate),
       KEY idx_user (type, user_id, status, is_delete, createdate),
       KEY idx_createdate (is_delete, createdate),
       KEY idx_wallpaper_user_type_status (user_id, type, is_delete, status, createdate)
       ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='壁纸表';
2 分类表 (category)
    CREATE TABLE IF NOT EXISTS category (
        id CHAR(21) NOT NULL COMMENT 'ID',
        name VARCHAR(50) NOT NULL COMMENT '分类名称',
        cover VARCHAR(255) NOT NULL COMMENT '封面图片URL',
        type TINYINT UNSIGNED DEFAULT 0 COMMENT '类型: 0-分类、1-专辑',
        sort TINYINT UNSIGNED DEFAULT 100 COMMENT '排序值(0-255)',
        status TINYINT UNSIGNED DEFAULT 1 COMMENT '状态: 0-禁用、1-启用',
        createdate DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
        updatedate DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
        PRIMARY KEY (id),
        UNIQUE KEY uni_name_type (name, type) COMMENT '分类名称+类型唯一约束',
        KEY idx_type_status (type, status, sort) COMMENT '类型+状态+排序复合索引',
        KEY idx_createdate (createdate) COMMENT '创建时间索引'
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='壁纸分类表';
3 用户表 (user)
    CREATE TABLE IF NOT EXISTS user (
        id CHAR(21) PRIMARY KEY COMMENT 'ID）',
        open_id VARCHAR(100) NOT NULL UNIQUE COMMENT '微信openid（唯一标识）',
        name VARCHAR(30) DEFAULT NULL COMMENT '用户昵称',
        avatar_url VARCHAR(255) DEFAULT NULL COMMENT '头像地址',
        gender TINYINT UNSIGNED DEFAULT NULL COMMENT '性别: null-未知、1-男、0-女',
        motto VARCHAR(800) DEFAULT NULL COMMENT '格言，限200zi',
        status TINYINT UNSIGNED DEFAULT 1 COMMENT '账号状态: 0-禁用、1-正常、2管理员',
        createdate DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
        KEY idx_name (name) COMMENT '昵称索引',
        KEY idx_createdate (createdate) COMMENT '注册时间索引',
        KEY idx_openid_status (open_id, status) COMMENT '优化登录场景：通过open_id查询并验证状态'
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='壁纸小程序用户表';
4 反馈表 (feedback)
    CREATE TABLE IF NOT EXISTS feedback (
        id INT PRIMARY KEY AUTO_INCREMENT,
        user_id CHAR(21) NOT NULL COMMENT '用户ID',
        wallpaper_id CHAR(21) NOT NULL COMMENT '壁纸ID',
        category_id CHAR(21) NOT NULL COMMENT '分类ID',
        type TINYINT UNSIGNED NOT NULL COMMENT '行为类型: 0-点赞、1-收藏、2-下载',
        status TINYINT UNSIGNED NOT NULL DEFAULT 1 COMMENT '行为状态: 1-有效、0-无效（如取消点赞/收藏）',
        createdate DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
        updatedate DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
        KEY idx_user_type (user_id ,wallpaper_id , type),
        KEY idx_feedback_wallpaper_type_status (wallpaper_id, type, status)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户反馈表（点赞/收藏/下载）';
5 问题反馈表 (problem)
    CREATE TABLE IF NOT EXISTS problem (
      ID INT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '反馈记录唯一ID',
      type TINYINT NOT NULL COMMENT '0表示问题反馈，1表示壁纸需求',
      content TEXT NOT NULL COMMENT '反馈的具体内容',
      user_id CHAR(21) NOT NULL COMMENT '用户ID',
      createdate DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
      PRIMARY KEY (ID)
      ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='问题反馈表，用于记录壁纸需求和问题反馈';
```

```
-- 壁纸表
CREATE TABLE `wallpaper` (
  `id` INT PRIMARY KEY AUTO_INCREMENT,
  `title` VARCHAR(100) NOT NULL COMMENT '壁纸标题',
  `description` VARCHAR(255) DEFAULT NULL COMMENT '壁纸描述',
  `category_id` INT NOT NULL COMMENT '分类ID',
  `user_id` INT DEFAULT NULL COMMENT '上传用户ID，NULL表示系统上传',
  `image_url` VARCHAR(255) NOT NULL COMMENT '图片地址',
  `thumbnail_url` VARCHAR(255) DEFAULT NULL COMMENT '缩略图地址',
  `width` INT DEFAULT 0 COMMENT '图片宽度',
  `height` INT DEFAULT 0 COMMENT '图片高度',
  `size` INT DEFAULT 0 COMMENT '图片大小(KB)',
  `format` VARCHAR(20) DEFAULT NULL COMMENT '图片格式(jpg/png/gif等)',
  `is_dynamic` TINYINT DEFAULT 0 COMMENT '是否动态壁纸 0-否 1-是',
  `download_count` INT DEFAULT 0 COMMENT '下载次数',
  `view_count` INT DEFAULT 0 COMMENT '浏览次数',
  `favor_count` INT DEFAULT 0 COMMENT '收藏次数',
  `is_hot` TINYINT DEFAULT 0 COMMENT '是否热门 0-否 1-是',
  `is_recommend` TINYINT DEFAULT 0 COMMENT '是否推荐 0-否 1-是',
  `status` TINYINT DEFAULT 1 COMMENT '状态 0-待审核 1-已通过 2-已拒绝',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (`category_id`) REFERENCES `category`(`id`),
  FOREIGN KEY (`user_id`) REFERENCES `user`(`id`)
);
-- 用户表
CREATE TABLE `user` (
  `id` VARCHAR(100) PRIMARY KEY ,
  `wx_id` VARCHAR(100) UNIQUE NOT NULL COMMENT '微信唯一标识',
  `name` VARCHAR(50) DEFAULT NULL COMMENT '用户昵称',
  `avatar_url` VARCHAR(255) DEFAULT NULL COMMENT '头像地址',
  `gender` INT DEFAULT 0 COMMENT '性别 0-未知 1-男 2-女',
  `motto` VARCHAR(255) DEFAULT NULL COMMENT '格言',
  `createdate` VARCHAR(100) NOT NULL COMMENT '创建时间'
);
-- 用户关注表
CREATE TABLE user_follows (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  user_id BIGINT NOT NULL COMMENT '关注者ID',
  target_id BIGINT NOT NULL COMMENT '被关注者ID',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '关注时间',
  UNIQUE KEY `uniq_user_target` (user_id, target_id)  -- 防止重复关注
);
-- 壁纸分类表
CREATE TABLE `category` (
  `id` VARCHAR(100)  PRIMARY KEY ,
  `name` VARCHAR(50) NOT NULL COMMENT '分类名称',
  `parent_id` INT DEFAULT 0 COMMENT '父分类ID，0表示顶级分类',
  `sort` INT DEFAULT 0 COMMENT '排序值',
  `status` TINYINT DEFAULT 1 COMMENT '状态 0-禁用 1-启用',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 用户收藏表
CREATE TABLE `user_favorite` (
  `id` INT PRIMARY KEY AUTO_INCREMENT,
  `user_id` INT NOT NULL COMMENT '用户ID',
  `wallpaper_id` INT NOT NULL COMMENT '壁纸ID',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (`user_id`) REFERENCES `user`(`id`),
  FOREIGN KEY (`wallpaper_id`) REFERENCES `wallpaper`(`id`),
  UNIQUE KEY `uk_user_wallpaper` (`user_id`, `wallpaper_id`)
);

-- 用户下载记录表
CREATE TABLE `user_download` (
  `id` INT PRIMARY KEY AUTO_INCREMENT,
  `user_id` INT NOT NULL COMMENT '用户ID',
  `wallpaper_id` INT NOT NULL COMMENT '壁纸ID',
  `device` VARCHAR(50) DEFAULT NULL COMMENT '下载设备',
  `system` VARCHAR(50) DEFAULT NULL COMMENT '操作系统',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (`user_id`) REFERENCES `user`(`id`),
  FOREIGN KEY (`wallpaper_id`) REFERENCES `wallpaper`(`id`)
);


-- 积分记录表
CREATE TABLE `points_log` (
  `id` INT PRIMARY KEY AUTO_INCREMENT,
  `user_id` INT NOT NULL COMMENT '用户ID',
  `points` INT NOT NULL COMMENT '积分变动值(正为增加，负为减少)',
  `type` TINYINT NOT NULL COMMENT '积分类型 1-每日登录 2-下载壁纸 3-分享小程序 4-兑换物品 5-管理员操作',
  `remark` VARCHAR(255) DEFAULT NULL COMMENT '备注',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (`user_id`) REFERENCES `user`(`id`)
);

-- 广告位表
CREATE TABLE `advert` (
  `id` INT PRIMARY KEY AUTO_INCREMENT,
  `position` VARCHAR(50) NOT NULL COMMENT '广告位置标识',
  `name` VARCHAR(100) DEFAULT NULL COMMENT '广告名称',
  `image_url` VARCHAR(255) DEFAULT NULL COMMENT '广告图片地址',
  `link_url` VARCHAR(255) DEFAULT NULL COMMENT '广告链接',
  `sort` INT DEFAULT 0 COMMENT '排序值',
  `status` TINYINT DEFAULT 1 COMMENT '状态 0-禁用 1-启用',
  `start_time` DATETIME DEFAULT NULL COMMENT '开始时间',
  `end_time` DATETIME DEFAULT NULL COMMENT '结束时间',
  `click_count` INT DEFAULT 0 COMMENT '点击次数',
  `show_count` INT DEFAULT 0 COMMENT '展示次数',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP
);    
```

